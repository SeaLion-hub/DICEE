# 바이브 코딩 시 주의사항 (CAUTIONS)

바이브 코딩 중 계획 이탈·변동·인프라 지뢰를 막기 위한 체크리스트. **코딩 전·중에** 이 문서를 한 번씩 보면 실수를 줄일 수 있다.

## 문서 링크

- [ROADMAP.md](./ROADMAP.md)
- [DEPLOYMENT.md](./DEPLOYMENT.md)
- [WORK_LOG.md](./WORK_LOG.md)

---

## 목차

- [Cursor 코딩 규칙](#cursor-코딩-규칙)
- [1. 계획·단계 관련](#1-계획단계-관련)
- [2. 구조·설정·시크릿](#2-구조설정시크릿)
- [3. 의존성·빌드](#3-의존성빌드)
- [4. 에러 처리·로깅·모니터링](#4-에러-처리로깅모니터링)
- [5. DB·마이그레이션](#5-db마이그레이션)
- [6. 크롤러·워커 (3단계)](#6-크롤러워커-3단계)
- [7. AI 파이프라인 (4단계)](#7-ai-파이프라인-4단계)
- [8. Auth·API (2·5·6단계)](#8-authapi-256단계)
- [9. 배포·인프라](#9-배포인프라)
- [10. 바이브 코딩 습관](#10-바이브-코딩-습관)
- [요약: 코딩 전 30초 체크](#요약-코딩-전-30초-체크)

---

## Cursor 코딩 규칙

바이브 코딩 시 자동 적용되는 규칙은 `.cursor/rules/`에 있다. 문법·계층·연동 실수를 줄이려면 코드 생성 전에 한 번 확인한다.

- **`tech-stack.mdc`**: SQLAlchemy 2.0(비동기)·Pydantic v2·Depends 강제, async 라우터에서 sync 블로킹 금지
- **`architecture.mdc`**: Router→Service→Repository 관심사 분리, 호출 방향 엄수, 예외는 Router/전역 핸들러에서만 HTTP로 변환
- **`integrations.mdc`**: Gemini Structured Output만 사용, Celery `rate_limit`·`asyncio.run` 래핑, Playwright 옵션·concurrency 제한
- **`user-actions.mdc`**: **사용자(나)가 직접 해야 할 설정/실행은 항상 명시**하고, **다음 단계로 넘어가기 전에 사용자 확인** 요청

---

## 1. 계획·단계 관련

| 주의사항 | 설명 | 대응 |
|----------|------|------|
| **현재 단계만 집중** | 다른 단계 기능을 미리 넣으면 의존성·복잡도만 늘어남. | ROADMAP "지금 상태"에서 현재 단계 확인. 이번 단계 목표만 달성할 것. |
| **새 기능·아이디어** | 코딩하다 새로 생각난 기능을 바로 구현하지 말 것. | ROADMAP 맨 아래 "추가 검토 아이디어"에만 적어 두고, 현재 단계 완료 후 검토. |
| **로드맵 본문 수정** | 단계 내용을 바꿀 때 이유 없이 고치면 나중에 혼란. | 수정 시 **날짜, 수정 내용, 이유**를 한 줄이라도 기록(ROADMAP 또는 WORK_LOG). |
| **WORK_LOG 미기록** | 나중에 "그때 뭘 바꿨지?" 복기 불가. | 작업 세션 끝날 때마다 **실제로 한 수정**을 WORK_LOG에 1~3줄이라도 기록. |
| **프론트 폴더** | 6단계 전에 `frontend/` 만들면 구조만 흐려짐. | 프론트엔드 폴더는 **6단계에서** 생성. 그 전까지 백엔드만. |

---

## 2. 구조·설정·시크릿

| 주의사항 | 설명 | 대응 |
|----------|------|------|
| **진입점 변경** | `main:app` vs `app.main:app` 혼동 시 배포·로컬 실행이 깨짐. | **진입점은 `app.main:app` 고정**. DEPLOYMENT Start Command와 일치. 루트에 `app/` 패키지. |
| **폴더 구조** | `api/`, `core/`, `services/` 등 위치를 맘대로 바꾸면 import 전부 깨짐. | ROADMAP 1단계 "계층형 디렉터리" 유지. 새 폴더는 `app/` 안에 추가. |
| **환경변수 하드코딩** | API 키·URL을 코드에 넣으면 커밋 시 유출. | 모든 설정은 **환경변수**. `.env.example`에는 **키 이름만**. 값은 로컬 .env·Railway Variables. |
| **.env 커밋** | 실수로 .env를 푸시하면 시크릿 유출. | 커밋 전 `.env` 포함 여부 확인. pre-commit 또는 스크립트로 방지. |
| **새 환경변수** | 코드에만 넣고 문서 안 바꾸면 배포·협업 시 누락. | 새 변수 추가 시 **DEPLOYMENT 표 + .env.example** 동시 갱신. |

---

## 3. 의존성·빌드

| 주의사항 | 설명 | 대응 |
|----------|------|------|
| **버전 미고정** | `pip install` 할 때마다 다른 버전 설치되면 "로컬에선 되는데 Railway에서 터짐". | `requirements.txt`에 **버전 고정**. pip-tools 권장. |
| **dev 패키지가 배포에 섞임** | 테스트/린트 전용 패키지가 production 빌드에 들어가면 불필요한 충돌·용량. | **requirements-dev.txt** 분리. CI/배포는 **requirements.txt**만 사용. |

---

## 4. 에러 처리·로깅·모니터링

| 주의사항 | 설명 | 대응 |
|----------|------|------|
| **except Exception** | 모든 예외를 잡고 로그만 남기면 데이터 무결성 깨진 채로 흐름이 계속됨. | **비즈니스 예외 → HTTPException**. 그 외는 500 + 로그. `except Exception` 남용 금지. |
| **Sentry 미부착** | 3·4단계에서 에러가 많이 나는데 6단계까지 기다리면 디버깅 지연. | **1단계에서 Sentry DSN** 세팅. 3단계에서 워커까지 확장. 에러 알림을 미리 받을 것. |
| **에러 메시지에 컨텍스트 없음** | "Error"만 남기면 원인 추적 불가. | 에러 로그/Sentry에 `task_id`, `notice_id`, `college_id` 등 **컨텍스트** 포함. |

---

## 5. DB·마이그레이션

| 주의사항 | 설명 | 대응 |
|----------|------|------|
| **로컬 vs Railway DB 혼동** | 로컬에서 마이그레이션만 돌리고 Railway는 안 돌리면 스키마 불일치. | **환경 정책** 명확히: 로컬 DATABASE_URL / Railway DATABASE_URL. 배포 시 마이그레이션 실행 주체·시점 정해 둠. |
| **마이그레이션 역방향** | down 마이그레이션으로 롤백하면 데이터 유실·충돌. | 마이그레이션은 **순서대로, up만** 적용. 롤백 필요 시 새 마이그레이션으로 복구. |
| **Raw SQL 문자열 조합** | 조건 추가할 때마다 문자열로 SQL 만들면 인젝션·버그 위험. | **ORM(SQLAlchemy)** 로만 쿼리. 동적 조건은 `where()`, `and_()` 등으로 조합. |

---

## 6. 크롤러·워커 (3단계)

| 주의사항 | 설명 | 대응 |
|----------|------|------|
| **Playwright OOM** | Railway에서 Chromium 여러 개 띄우면 RAM 초과로 OOM Kill. | 브라우저 옵션 **`--no-sandbox`, `--disable-dev-shm-usage`** 필수. **Celery concurrency 1~2**로 제한. |
| **크롤러 설정 하드코딩** | 사이트 개편 시 CSS 선택자·URL을 코드에서 매번 수정·재배포해야 함. | **선택자·URL 패턴·페이징 규칙**은 JSON config 또는 DB로 분리. config만 갱신해 재배포 없이 적용. |
| **중복 수집** | 재실행 시 같은 공지가 두 번 들어감. | 공지 식별은 **(college_id, external_id)** 로 **유니크**. URL은 페이징/쿼리에 따라 변동되어 중복 위험이 있으므로 사용하지 않음. 저장은 **upsert**. |
| **실패 시 복구 없음** | 잘못된 데이터 대량 적재 시 되돌릴 방법이 없음. | 특정 기간/소스만 **삭제 후 재수집**하는 스크립트 또는 절차를 두기. |
| **Nixpacks로 워커 배포** | Playwright 워커를 Nixpacks로 올리면 "Browser executable not found". | Playwright 워커는 **Dockerfile**로만 빌드. `RUN playwright install --with-deps chromium` 포함. |

---

## 7. AI 파이프라인 (4단계)

| 주의사항 | 설명 | 대응 |
|----------|------|------|
| **429 폭주** | 큐에 공지가 많이 쌓인 상태에서 워커가 Gemini를 동시에 많이 호출하면 429. | Celery 태스크에 **rate_limit**(예: `10/m`) 반드시 명시. **429 재시도 시 지수 백오프**(2초→4초→8초) 적용. |
| **AI 환각·정보 누락** | 핵심 조건(학과·학년 등)을 AI가 놓치면 사용자 피해. | 프롬프트에 **"애매하면 노출(True)"** 규칙 명시. False Positive 지향 설계. |
| **자격 요건 스키마 불일치** | 4단계 AI 출력 JSON과 5단계 매칭 로직이 필드명·형식이 다르면 매칭 깨짐. | **자격 요건 Pydantic 모델을 한 곳에서 정의**. 4·5단계가 동일 스키마 import. 스키마 변경 시 4·5 함께 수정. |
| **파싱으로 JSON 추출** | AI 응답에서 `re.search`·`find('{')`로 JSON을 긁지 말 것. | **Structured Output**(Gemini response_schema에 Pydantic 전달)으로만 JSON 받기. |
| **재처리 불가** | AI가 잘못 처리한 공지를 다시 돌릴 방법이 없음. | **재큐** 또는 **스킵 플래그**로 재처리 가능하게 설계. |

---

## 8. Auth·API (2·5·6단계)

| 주의사항 | 설명 | 대응 |
|----------|------|------|
| **OAuth 핸드쉐이크 미정** | 프론트(Vercel)와 백(Railway)이 다른 도메인인데, 토큰 주고받는 방식을 6단계에서만 정하면 CORS·보안으로 일주일 낭비. | **2단계에서** "프론트가 code를 백으로 전달 → 백이 JWT 발급 → body JSON vs HttpOnly Cookie" 중 하나로 **핸드쉐이크 확정**. CORS·Credentials를 그에 맞춰 설계. |
| **API 버전 없음** | 나중에 필드명 바꾸면 프론트 연쇄 수정. | 공개 API는 **`/v1/` prefix**. 기존 필드 삭제·이름 변경 금지. 추가만 하거나 /v2/로. |
| **ALLOWED_ORIGINS 누락** | 6단계에서 프론트 도메인을 안 넣으면 CORS 에러. | 6단계 연동 전에 Railway Variables에 **ALLOWED_ORIGINS**(Vercel URL) 설정. |

---

## 9. 배포·인프라

| 주의사항 | 설명 | 대응 |
|----------|------|------|
| **비용·리소스 무시** | 웹+DB+Redis+워커 동시 운영 시 Railway 한도·비용을 안 보면 갑자기 과금·다운. | DEPLOYMENT "비용·리소스" 참고. 플랜별 제한·월 상한을 주기적으로 확인. |
| **Start Command 불일치** | 로컬은 `main:app`, Railway는 `app.main:app` 처럼 다르면 배포만 실패. | **DEPLOYMENT와 ROADMAP의 진입점·Start Command** 와 코드가 일치하는지 확인. |

---

## 10. 바이브 코딩 습관

| 주의사항 | 설명 | 대응 |
|----------|------|------|
| **한 번에 여러 단계** | 1단계 하다가 2단계 DB 모델까지 만들어 버리면 검증·롤백이 어려움. | **한 단계 마일스톤을 달성한 뒤** 다음 단계로. WORK_LOG로 "이번에 한 것" 경계 유지. |
| **검증 생략** | "동작하는 것 같다"로 넘어가면 나중에 회귀 버그. | 단계 완료 시 **자동 검증**(CI에서 health 체크, 마이그레이션 성공 등)을 가능한 범위에서 추가. |
| **문서 업데이트 안 함** | 코드만 바꾸고 ROADMAP·DEPLOYMENT를 안 고치면, 나중에 다른 환경에서 재현 불가. | 구조·진입점·환경변수·정책이 바뀌면 **해당 문서를 즉시** 갱신. |
| **하드코딩** | URL·키워드·선택자를 코드에 박아 두면 사이트/정책이 바뀔 때마다 코드 수정. | 설정 가능한 것은 **config·환경변수·DB**로 분리. |

---

## 요약: 코딩 전 30초 체크

1. **지금 단계**가 ROADMAP과 맞는가?
2. **진입점** `app.main:app`, **폴더** `app/` 안 유지하는가?
3. **새 환경변수** 썼으면 DEPLOYMENT + .env.example 갱신했는가?
4. **except Exception** 없이, **Sentry** 붙여 두었는가?
5. **Playwright** 쓸 때 브라우저 옵션 + **concurrency 1~2** 인가?
6. **자격 요건 스키마**는 4·5단계 공유, **API**는 `/v1/`, **OAuth**는 2단계 핸드쉐이크 확정했는가?
7. 작업 끝나면 **WORK_LOG**에 한 줄이라도 썼는가?

이 문서는 ROADMAP·비판 반영 내용을 바탕으로 작성됨. 수정·추가 시 WORK_LOG에 기록할 것.
